version: "3.9"

services:
  traefik:
    image: traefik:v3.1
    container_name: traefik
    restart: unless-stopped
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.web.http.redirections.entryPoint.to=:443
      - --entrypoints.web.http.redirections.entryPoint.scheme=https
      - --entrypoints.websecure.address=:443
      - --certificatesresolvers.le.acme.email=SEU_EMAIL@EXEMPLO.COM
      - --certificatesresolvers.le.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.le.acme.httpchallenge=true
      - --certificatesresolvers.le.acme.httpchallenge.entrypoint=web
      - --api.dashboard=false
      - --entrypoints.redis-tls.address=:6380
    ports:
      - "80:80"
      - "443:443"
      - "6380:6380"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_letsencrypt:/letsencrypt

  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:latest
    container_name: redpanda
    restart: unless-stopped
    command:
      - redpanda
      - start
      - --smp
      - "1"
      - --memory
      - 1G
      - --overprovisioned
      - --node-id
      - "0"
      - --kafka-addr
      - PLAINTEXT://0.0.0.0:29092
      - --advertise-kafka-addr
      - PLAINTEXT://redpanda:29092
    volumes:
      - redpanda_data:/var/lib/redpanda/data

  schema-registry:
    image: confluentinc/cp-schema-registry:7.5.0
    container_name: schema-registry
    restart: unless-stopped
    depends_on: [ redpanda ]
    environment:
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: "redpanda:29092"
      SCHEMA_REGISTRY_LISTENERS: "http://0.0.0.0:8081"
    labels:
      - traefik.enable=true
      - traefik.http.routers.schema.rule=Host(`iot-kafka-pip.northcentralus.cloudapp.azure.com`) && PathPrefix(`/schema`)
      - traefik.http.routers.schema.entrypoints=websecure
      - traefik.http.routers.schema.tls.certresolver=le
      - traefik.http.middlewares.schema-strip.stripPrefix.prefixes=/schema
      - traefik.http.routers.schema.middlewares=schema-strip
      - traefik.http.services.schema-svc.loadbalancer.server.port=8081
  
  
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    command: ["redis-server","--appendonly","yes",
              "--requirepass","${REDIS_PASSWORD}",
              "--bind","0.0.0.0","--protected-mode","no"]
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    ports:
      - "6379:6379"
    # NÃO exponha ports aqui; quem expõe é o Traefik
    labels:
      traefik.enable: "true"
      traefik.tcp.routers.redis-tcp.rule: "HostSNI(`iot-kafka-pip.northcentralus.cloudapp.azure.com`)"
      traefik.tcp.routers.redis-tcp.entrypoints: "redis-tls"
      traefik.tcp.routers.redis-tcp.tls.certresolver: "le"
      traefik.tcp.routers.redis-tcp.service: "redis-tcp-svc"
      traefik.tcp.services.redis-tcp-svc.loadbalancer.server.port: "6379"

  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: redis-commander
    restart: unless-stopped
    depends_on: [ redis ]
    environment:
      REDIS_HOSTS: "local:redis:6379:0:${REDIS_PASSWORD}"
    labels:
      traefik.enable: "true"

      # (A) /redis -> /redis/ (301)
      traefik.http.middlewares.redis-slash.redirectregex.regex: "^/redis$"
      traefik.http.middlewares.redis-slash.redirectregex.replacement: "/redis/"
      traefik.http.middlewares.redis-slash.redirectregex.permanent: "true"

      traefik.http.routers.redis-root.rule: "Host(`iot-kafka-pip.northcentralus.cloudapp.azure.com`) && Path(`/redis`)"
      traefik.http.routers.redis-root.entrypoints: "websecure"
      traefik.http.routers.redis-root.tls.certresolver: "le"
      traefik.http.routers.redis-root.middlewares: "redis-slash"
      traefik.http.routers.redis-root.service: "redis-svc"
      traefik.http.routers.redis-root.priority: "1000"

      # (B) tudo sob /redis/ vai pro app (strip do prefixo)
      traefik.http.middlewares.redis-strip.stripPrefix.prefixes: "/redis"
      traefik.http.middlewares.redis-xfp.headers.customrequestheaders.X-Forwarded-Prefix: "/redis"

      traefik.http.routers.redis.rule: "Host(`iot-kafka-pip.northcentralus.cloudapp.azure.com`) && PathPrefix(`/redis/`)"
      traefik.http.routers.redis.entrypoints: "websecure"
      traefik.http.routers.redis.tls.certresolver: "le"
      traefik.http.routers.redis.middlewares: "redis-strip,redis-xfp"
      traefik.http.routers.redis.priority: "900"
      traefik.http.routers.redis.service: "redis-svc"

      traefik.http.services.redis-svc.loadbalancer.server.port: "8081"
  redpanda-console:
    image: docker.redpanda.com/redpandadata/console:latest
    container_name: redpanda-console
    restart: unless-stopped
    depends_on: [ redpanda ]
    environment:
      KAFKA_BROKERS: "redpanda:29092"
      REDPANDA_ADMIN_URL: "http://redpanda:9644"
      SERVER_LISTEN_ADDRESS: "0.0.0.0:8080"
    labels:
      - traefik.enable=true
      # /console
      - traefik.http.routers.console.rule=Host(`iot-kafka-pip.northcentralus.cloudapp.azure.com`) && PathPrefix(`/console`)
      - traefik.http.routers.console.entrypoints=websecure
      - traefik.http.routers.console.tls.certresolver=le
      - traefik.http.middlewares.console-strip.stripPrefix.prefixes=/console
      - traefik.http.routers.console.middlewares=console-strip
      - traefik.http.services.console-svc.loadbalancer.server.port=8080
      # raiz -> /console
      - traefik.http.middlewares.to-console.redirectregex.regex=^/$
      - traefik.http.middlewares.to-console.redirectregex.replacement=/console
      - traefik.http.middlewares.to-console.redirectregex.permanent=true
      - traefik.http.routers.root.rule=Host(`iot-kafka-pip.northcentralus.cloudapp.azure.com`) && Path(`/`)
      - traefik.http.routers.root.entrypoints=websecure
      - traefik.http.routers.root.tls.certresolver=le
      - traefik.http.routers.root.middlewares=to-console

  mqtt-kafka-bridge:
    image: iotkafkaacrwtvgek.azurecr.io/mqtt-kafka-bridge:latest
    container_name: mqtt-kafka-bridge
    restart: always
    depends_on: [ redpanda ]
    environment:
      MQTT_BROKER: "broker.hivemq.com"
      MQTT_PORT: 1883
      KAFKA_BROKER: "redpanda:29092"
      KAFKA_TOPIC: "iot-data"
    labels:
      - traefik.enable=true

      # --- Roteamento principal sob /bridge (tira o prefixo) ---
      - traefik.http.routers.bridge-root.rule=Host(`iot-kafka-pip.northcentralus.cloudapp.azure.com`) && Path(`/bridge`)
      - traefik.http.routers.bridge-root.entrypoints=websecure
      - traefik.http.routers.bridge-root.tls.certresolver=le
      - traefik.http.middlewares.bridge-slash.redirectregex.regex=^/bridge$
      - traefik.http.middlewares.bridge-slash.redirectregex.replacement=/bridge/
      - traefik.http.middlewares.bridge-slash.redirectregex.permanent=true
      - traefik.http.routers.bridge-root.middlewares=bridge-slash
      - traefik.http.routers.bridge-root.priority=500

      - traefik.http.routers.bridge.rule=Host(`iot-kafka-pip.northcentralus.cloudapp.azure.com`) && PathPrefix(`/bridge/`)
      - traefik.http.routers.bridge.entrypoints=websecure
      - traefik.http.routers.bridge.tls.certresolver=le
      - traefik.http.middlewares.bridge-strip.stripPrefix.prefixes=/bridge
      - traefik.http.middlewares.bridge-xfp.headers.customrequestheaders.X-Forwarded-Prefix=/bridge
      - traefik.http.routers.bridge.middlewares=bridge-strip,bridge-xfp
      - traefik.http.routers.bridge.priority=400
      - traefik.http.routers.bridge.service=bridge-svc
      - traefik.http.services.bridge-svc.loadbalancer.server.port=8000

      # --- Compatibilidade para Swagger que chama caminhos "na raiz" ---
      - traefik.http.routers.bridge-openapi.rule=Host(`iot-kafka-pip.northcentralus.cloudapp.azure.com`) && Path(`/openapi.json`)
      - traefik.http.routers.bridge-openapi.entrypoints=websecure
      - traefik.http.routers.bridge-openapi.tls.certresolver=le
      - traefik.http.routers.bridge-openapi.priority=600
      - traefik.http.routers.bridge-openapi.service=bridge-svc

      - traefik.http.routers.bridge-docs.rule=Host(`iot-kafka-pip.northcentralus.cloudapp.azure.com`) && (Path(`/docs`) || PathPrefix(`/docs/`) || Path(`/redoc`) || PathPrefix(`/redoc/`))
      - traefik.http.routers.bridge-docs.entrypoints=websecure
      - traefik.http.routers.bridge-docs.tls.certresolver=le
      - traefik.http.routers.bridge-docs.priority=600
      - traefik.http.routers.bridge-docs.service=bridge-svc

  kafka-redis-consumer:
    image: iotkafkaacrwtvgek.azurecr.io/kafka-redis-consumer:latest
    container_name: kafka-redis-consumer
    restart: always
    depends_on: [ redpanda, redis ]
    environment:
      KAFKA_BROKER: "redpanda:29092"
      KAFKA_TOPIC: "iot-data"
      REDIS_HOST: "redis"
      REDIS_PASSWORD: "1234"

  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /home/azureuser/.docker/config.json:/config.json:ro
    command: --interval 60 --cleanup mqtt-kafka-bridge kafka-redis-consumer

volumes:
  redpanda_data:
  traefik_letsencrypt:
  redis_data:
