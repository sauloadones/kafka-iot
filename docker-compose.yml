version: "3.8"

services:
  # --- Proxy/Nginx (edge) ---
  edge:
    image: iotkafka.azurecr.io/edge:live
    restart: always
    depends_on:
      - redpanda
      - redpanda-console
      - schema-registry
      - redis
      - redis-commander
      - mqtt-kafka-bridge
      - kafka-redis-consumer
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "80:80"

  # --- Redpanda (Kafka) ---
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:latest
    restart: always
    command: >
      redpanda start --smp 1 --memory 1G --overprovisioned
      --node-id 0
      --kafka-addr PLAINTEXT://0.0.0.0:29092
      --advertise-kafka-addr PLAINTEXT://redpanda:29092
    expose: ["29092"]

  schema-registry:
    image: confluentinc/cp-schema-registry:7.5.0
    restart: always
    environment:
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: PLAINTEXT://redpanda:29092
      SCHEMA_REGISTRY_LISTENERS: http://0.0.0.0:8081
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
    expose: ["8081"]
    depends_on: [redpanda]

  redpanda-console:
    image: docker.redpanda.com/redpandadata/console:latest
    restart: always
    environment:
      KAFKA_BROKERS: redpanda:29092
      SCHEMAREGISTRY_ENABLED: "true"
      SCHEMAREGISTRY_URLS: http://schema-registry:8081
      CONSOLE_LISTEN_ADDRESS: 0.0.0.0:8080
    expose: ["8080"]
    depends_on: [redpanda, schema-registry]

  # --- Redis seguro ---
  redis:
    image: redis/redis-stack-server:7.4.0-v2
    restart: always
    command:
      - /bin/sh
      - -lc
      - |
        exec redis-server --appendonly yes \
                          --bind 0.0.0.0 \
                          --protected-mode yes \
                          --requirepass "$${REDIS_PASSWORD}"
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    expose: ["6379"]

  # UI do Redis (sem URL_PREFIX; com senha)
  redis-commander:
    image: rediscommander/redis-commander:latest
    restart: always
    environment:
      PORT: "8081"
      # label:host:port:db:password
      REDIS_HOSTS: local:redis:6379:0:${REDIS_PASSWORD}
      HTTP_USER: admin
      HTTP_PASSWORD: ${REDIS_CMD_PASS}
    expose: ["8081"]
    depends_on: [redis]

  # --- FastAPI bridge ---
  mqtt-kafka-bridge:
    image: iotkafka.azurecr.io/mqtt-kafka-bridge:live
    restart: always
    command: >
      uvicorn app.main:app --host 0.0.0.0 --port 8000
      --root-path /api --proxy-headers --forwarded-allow-ips="*"
    environment:
      KAFKA_BOOTSTRAP: redpanda:29092
      SCHEMA_REGISTRY_URL: http://schema-registry:8081
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      PYTHONUNBUFFERED: "1"
    expose: ["8000"]
    depends_on: [redpanda, schema-registry, redis]

  kafka-redis-consumer:
    image: iotkafka.azurecr.io/kafka-redis-consumer:live
    restart: always
    environment:
      KAFKA_BOOTSTRAP: redpanda:29092
      GROUP_ID: kafka-redis-consumer-group
      SESSION_TIMEOUT_MS: "30000"
      HEARTBEAT_INTERVAL_MS: "10000"
      TOPIC: iot-data
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    depends_on: [redpanda, redis]
