name: CI/CD — App Service (docker-compose, credenciais ACR)

on:
  push: { branches: ["main"] }
  workflow_dispatch:

permissions:
  contents: read

env:
  ACR_NAME:        ${{ vars.ACR_NAME }}
  REGISTRY:        ${{ vars.ACR_NAME }}.azurecr.io
  RESOURCE_GROUP:  ${{ vars.AZ_RESOURCE_GROUP }}
  WEBAPP_NAME:     ${{ vars.AZ_WEBAPP_NAME }}
  COMPOSE_FILE:    docker-compose.yml
  IMAGE_TAG:       ${{ github.sha }}
  PRIVATE_SERVICES: "mqtt-kafka-bridge kafka-redis-consumer edge"

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      images: ${{ steps.images.outputs.list }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure login (service principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - uses: docker/setup-buildx-action@v3

      - name: Login no ACR
        run: az acr login -n "$ACR_NAME"

      - name: Build & Push (serviços privados)
        shell: bash
        run: |
          set -euo pipefail
          export REGISTRY="${{ env.REGISTRY }}"
          export REGISTRY_PREFIX="${REGISTRY}/"
          export IMAGE_TAG="${{ env.IMAGE_TAG }}"

          PRESENT=$(docker compose -f "${COMPOSE_FILE}" config --services)
          for s in $PRIVATE_SERVICES; do
            if echo "$PRESENT" | grep -qx "$s"; then
              echo ">> build/push: $s"
              docker compose -f "${COMPOSE_FILE}" build "$s"
              docker compose -f "${COMPOSE_FILE}" push  "$s"
            else
              echo ">> skip: $s (não está no compose)"
            fi
          done

      - name: Resolver imagens do compose (expand env)
        id: images
        shell: bash
        run: |
          set -euo pipefail
          export REGISTRY="${{ env.REGISTRY }}"
          export REGISTRY_PREFIX="${REGISTRY}/"
          export IMAGE_TAG="${{ env.IMAGE_TAG }}"

          docker compose -f "${COMPOSE_FILE}" config \
            | awk '/image:/ {print $2}' \
            | tr -d "\"'" > images.txt

          # escreve saída multilinha no GITHUB_OUTPUT de forma atômica
          {
            echo 'list<<EOF'
            cat images.txt
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure login (service principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configurar App Settings (ACR + porta + warmup)
        shell: bash
        run: |
          set -euo pipefail
          az webapp config appsettings set -g "$RESOURCE_GROUP" -n "$WEBAPP_NAME" --settings \
            DOCKER_REGISTRY_SERVER_URL="https://${{ env.REGISTRY }}" \
            DOCKER_REGISTRY_SERVER_USERNAME="${{ secrets.ACR_USERNAME }}" \
            DOCKER_REGISTRY_SERVER_PASSWORD="${{ secrets.ACR_PASSWORD }}" \
            WEBSITES_ENABLE_APP_SERVICE_STORAGE=true \
            WEBSITES_PORT=80 \
            WEBSITES_CONTAINER_START_TIME_LIMIT=240 >/dev/null

      - name: Ajustar Health Check (/healthz) e Always On
        shell: bash
        run: |
          set -euo pipefail
          if ! az webapp update
