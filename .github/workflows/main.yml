name: CI/CD — App Service (docker-compose, SP secret)

on:
  push: { branches: [ "main" ] }
  workflow_dispatch:

permissions:
  contents: read

env:
  ACR_NAME:        ${{ vars.ACR_NAME }}
  REGISTRY:        ${{ vars.ACR_NAME }}.azurecr.io
  RESOURCE_GROUP:  ${{ vars.AZ_RESOURCE_GROUP }}
  WEBAPP_NAME:     ${{ vars.AZ_WEBAPP_NAME }}
  COMPOSE_FILE:    docker-compose.yml
  IMAGE_TAG:       ${{ github.sha }}
  PRIVATE_SERVICES: "mqtt-kafka-bridge kafka-redis-consumer edge"

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure login (service principal secret)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - uses: docker/setup-buildx-action@v3

      - name: Login no ACR
        run: az acr login -n "$ACR_NAME"

      - name: Build & Push (somente serviços privados que existirem no compose)
        run: |
          export REGISTRY="${{ env.REGISTRY }}"
          export IMAGE_TAG="${{ env.IMAGE_TAG }}"
          PRESENT=$(docker compose -f "${COMPOSE_FILE}" config --services)
          for s in $PRIVATE_SERVICES; do
            if echo "$PRESENT" | grep -qx "$s"; then
              docker compose -f "${COMPOSE_FILE}" build "$s"
              docker compose -f "${COMPOSE_FILE}" push  "$s"
            fi
          done

      - name: Resolver imagens do compose (expand env)
        id: images
        shell: bash
        run: |
          export REGISTRY="${{ env.REGISTRY }}"
          export IMAGE_TAG="${{ env.IMAGE_TAG }}"
          docker compose -f "${COMPOSE_FILE}" config | awk '/image:/ {print $2}' | tr -d "\"'" > images.txt
          echo "list<<EOF" >> $GITHUB_OUTPUT
          cat images.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "==== Imagens detectadas ===="
          cat images.txt

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure login (service principal secret)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy docker-compose ao App Service
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.WEBAPP_NAME }}
          configuration-file: ./${{ env.COMPOSE_FILE }}
          images: ${{ steps.images.outputs.list }}
