# websockets
map $http_upgrade $connection_upgrade { default upgrade; '' close; }

server {
  listen 80 default_server;
  server_name _;

  # health sem corpo (sobe rápido no App Service)
  location = /healthz { access_log off; return 204; }

  # conveniências de barra
  location = /        { return 301 /console/; }
  location = /console { return 301 /console/; }
  location = /redis   { return 301 /redis/; }
  location = /api     { return 301 /api/; }
  location = /docs         { return 301 /api/docs; }
  location = /openapi.json { return 308 /api/openapi.json; }

  # --- Cabeçalhos padrão para reuso (menos copy-paste) ---
  # (se preferir inline, pode manter em cada location)
  set $xfprefix '';
  # pequenas boas práticas globais
  client_max_body_size 20m;
  add_header X-Content-Type-Options nosniff always;

  # --- Console (já ok) ---
  location ^~ /console/ {
    # Forwarded basics
    proxy_set_header Host               $host;
    proxy_set_header X-Forwarded-Host   $host;
    proxy_set_header X-Forwarded-Proto  $scheme;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-Prefix /console;

    # WebSocket
    proxy_http_version 1.1;
    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    # Streaming amigável ao Console
    proxy_buffering off;
    proxy_read_timeout 600s;
    proxy_send_timeout 600s;

    # strip do prefixo para o upstream (console serve em /)
    rewrite ^/console/(.*)$ /$1 break;
    proxy_pass http://redpanda-console:8080/;
  }

  # --- Redis Commander em /redis/ (preservar caminho) ---
  location ^~ /redis/ {
    proxy_set_header Host               $host;
    proxy_set_header X-Forwarded-Host   $host;
    proxy_set_header X-Forwarded-Proto  $scheme;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-Prefix /redis;

    proxy_http_version 1.1;
    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_buffering off;
    proxy_read_timeout 600s;
    proxy_send_timeout 600s;

    # Preservar o caminho (NÃO stripar): sem / no final
    proxy_pass http://redis-commander:8081;
    proxy_redirect off;
  }

  # --- Swagger/FastAPI do bridge em /api/ ---
  location ^~ /api/ {
    proxy_set_header Host               $host;
    proxy_set_header X-Forwarded-Host   $host;
    proxy_set_header X-Forwarded-Proto  $scheme;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-Prefix /api;

    proxy_http_version 1.1;
    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    # strip do /api para o app (ele roda com --root-path /api)
    rewrite ^/api/(.*)$ /$1 break;
    proxy_pass http://mqtt-kafka-bridge:8000/;

    # timeouts razoáveis p/ SSE/WebSocket ou requests longas
    proxy_buffering off;
    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
  }
}
