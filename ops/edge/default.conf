# websockets
map $http_upgrade $connection_upgrade { default upgrade; '' close; }

# preserva o proto original (https) se vier do front
map $http_x_forwarded_proto $forwarded_proto {
  default $http_x_forwarded_proto;
  ''      $scheme;
}

server {
  listen 80 default_server;
  server_name _;
  resolver 127.0.0.11 ipv6=off valid=10s;
  resolver_timeout 5s;

  # health
  location = /healthz { access_log off; return 204; }
  location ~ ^/robots.*\.txt$ { access_log off; return 204; }

  # conveniÃªncias
  location = /        { return 301 /console/; }
  location = /console { return 301 /console/; }
  location = /redis   { return 301 /redis/; }
  location = /api     { return 301 /api/; }
  location = /docs         { return 301 /api/docs; }
  location = /openapi.json { return 308 /api/openapi.json; }

  client_max_body_size 20m;
  add_header X-Content-Type-Options nosniff always;

  # --- Redpanda Console em /console/ ---
  location ^~ /console/ {
    proxy_set_header Host               $host;
    proxy_set_header X-Forwarded-Host   $host;
    proxy_set_header X-Forwarded-Proto  $forwarded_proto;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-Prefix /console;
    proxy_set_header X-Original-URI     $request_uri;

    proxy_http_version 1.1;
    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_buffering off;
    proxy_read_timeout 600s;
    proxy_send_timeout 600s;

    rewrite ^/console/(.*)$ /$1 break;
    proxy_pass http://redpanda-console:8080/;

    # lida melhor com corrida de subida do upstream
    proxy_next_upstream error timeout http_502 http_503 http_504;
    proxy_connect_timeout 5s;
  }

  # --- Redis Commander em /redis/ (strip do prefixo) ---
  location ^~ /redis/ {
    proxy_set_header Host               $host;
    proxy_set_header X-Forwarded-Host   $host;
    proxy_set_header X-Forwarded-Proto  $forwarded_proto;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_http_version 1.1;
    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    rewrite ^/redis/(.*)$ /$1 break;
    proxy_pass http://redis-commander:8081/;
    proxy_redirect off;

    proxy_next_upstream error timeout http_502 http_503 http_504;
    proxy_connect_timeout 5s;
  }

  # --- FastAPI/Swagger do bridge em /api/ ---
  location ^~ /api/ {
    proxy_set_header Host               $host;
    proxy_set_header X-Forwarded-Host   $host;
    proxy_set_header X-Forwarded-Proto  $forwarded_proto;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-Prefix /api;
    proxy_set_header X-Original-URI     $request_uri;

    proxy_http_version 1.1;
    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    rewrite ^/api/(.*)$ /$1 break;
    proxy_pass http://mqtt-kafka-bridge:8000/;

    proxy_buffering off;
    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
    proxy_next_upstream error timeout http_502 http_503 http_504;
    proxy_connect_timeout 5s;
  }
}
