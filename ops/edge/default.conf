# websockets
map $http_upgrade $connection_upgrade { default upgrade; '' close; }

# preserve o proto original do front (https) quando existir
map $http_x_forwarded_proto $forwarded_proto {
  default $http_x_forwarded_proto;
  ''      $scheme;
}

server {
  listen 80 default_server;
  server_name _;

  # health sem corpo (sobe rápido no App Service)
  location = /healthz { access_log off; return 204; }

  # conveniências de barra
  location = /        { return 301 /console/; }
  location = /console { return 301 /console/; }
  location = /redis   { return 301 /redis/; }
  location = /api     { return 301 /api/; }
  location = /docs         { return 301 /api/docs; }
  location = /openapi.json { return 308 /api/openapi.json; }

  # boas práticas globais
  client_max_body_size 20m;
  add_header X-Content-Type-Options nosniff always;

  # --- Redpanda Console em /console/ ---
  location ^~ /console/ {
    proxy_set_header Host               $host;
    proxy_set_header X-Forwarded-Host   $host;
    proxy_set_header X-Forwarded-Proto  $forwarded_proto;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-Prefix /console;
    proxy_set_header X-Original-URI     $request_uri;

    proxy_http_version 1.1;
    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_buffering off;
    proxy_read_timeout 600s;
    proxy_send_timeout 600s;

    rewrite ^/console/(.*)$ /$1 break;
    proxy_pass http://redpanda-console:8080/;
  }

  # --- Redis Commander em /redis/ (preserva caminho) ---
  location ^~ /redis/ {
    proxy_set_header Host               $host;
    proxy_set_header X-Forwarded-Host   $host;
    proxy_set_header X-Forwarded-Proto  $forwarded_proto;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-Prefix /redis;
    proxy_set_header X-Original-URI     $request_uri;

    proxy_http_version 1.1;
    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_buffering off;
    proxy_read_timeout 600s;
    proxy_send_timeout 600s;

    # sem barra no final para NÃO stripar o prefixo:
    proxy_pass http://redis-commander:8081;
    proxy_redirect off;
  }

  # --- FastAPI/Swagger do bridge em /api/ ---
  location ^~ /api/ {
    proxy_set_header Host               $host;
    proxy_set_header X-Forwarded-Host   $host;
    proxy_set_header X-Forwarded-Proto  $forwarded_proto;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-Prefix /api;
    proxy_set_header X-Original-URI     $request_uri;

    proxy_http_version 1.1;
    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    # o app roda com --root-path /api; aqui stripamos /api na requisição interna
    rewrite ^/api/(.*)$ /$1 break;
    proxy_pass http://mqtt-kafka-bridge:8000/;

    proxy_buffering off;
    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
  }
}
