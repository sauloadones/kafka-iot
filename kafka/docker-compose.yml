services:
  # --- Kafka (Redpanda) ---
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:latest
    container_name: redpanda
    command:
      - redpanda start --smp 1 --memory 1G --overprovisioned --node-id 0
      - --kafka-addr PLAINTEXT://0.0.0.0:29092
      - --advertise-kafka-addr PLAINTEXT://redpanda:29092
    ports:
      - "9092:9092"
      - "9644:9644"
    volumes:
      - redpanda_data:/var/lib/redpanda/data

  # --- Schema Registry---
  schema-registry:
    image: confluentinc/cp-schema-registry:7.5.0
    container_name: schema-registry
    depends_on:
      - redpanda
    ports:
      - "8083:8083"
    environment:
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: 'redpanda:29092'
      SCHEMA_REGISTRY_LISTENERS: http://0.0.0.0:8083


  # --- Redis ---
  redis:
    image: "redis:alpine"
    container_name: redis
    ports:
      - "6379:6379"

  # --- RedisInsight (Interface Gráfica para Redis) ---
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: redis-commander
    ports:
      - "8081:8081"
    depends_on:
      - redis
    environment:
      REDIS_HOSTS: local:redis:6379

  # --- Redpanda Console (Interface Gráfica) ---
  redpanda-console:
    image: docker.redpanda.com/redpandadata/console:latest
    container_name: redpanda-console
    depends_on:
      - redpanda
    ports:
      - "8080:8080"
    environment:
      KAFKA_BROKERS: "redpanda:29092"

  # --- Python Bridge MQTT → Kafka ---
  mqtt-kafka-bridge:
    build:
      context: ./python-bridge
    container_name: mqtt-kafka-bridge
    restart: always
    ports:
      - "8000:8000"
    depends_on:
      - redpanda
    environment:
      MQTT_BROKER: "broker.hivemq.com"
      MQTT_PORT: 1883
      KAFKA_BROKER: "redpanda:29092"
      KAFKA_TOPIC: "iot-data"

  kafka-redis-consumer:
    build:
      context: ./kafka-redis-consumer
    container_name: kafka-redis-consumer
    restart: always
    depends_on:
      - redpanda
      - redis
    environment:
      KAFKA_BROKER: "redpanda:29092"
      KAFKA_TOPIC: "iot-data"
      REDIS_HOST: "redis"


volumes:
  redpanda_data: